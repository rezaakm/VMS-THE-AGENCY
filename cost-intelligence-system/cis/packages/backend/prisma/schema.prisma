generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "fullTextIndex"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Client {
  id        String    @id @default(uuid())
  name      String    @unique
  aliases   String[]
  email     String?
  projects  Project[]
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@map("clients")
}

model Vendor {
  id               String     @id @default(uuid())
  name             String     @unique
  aliases          String[]
  contactName      String?    @map("contact_name")
  phone            String?
  email            String?
  categories       String[]
  reliabilityScore Float?     @default(3.0) @map("reliability_score")
  isActive         Boolean    @default(true) @map("is_active")
  notes            String?
  lineItems        LineItem[]
  createdAt        DateTime   @default(now()) @map("created_at")
  updatedAt        DateTime   @updatedAt @map("updated_at")

  @@map("vendors")
}

model Project {
  id         String     @id @default(uuid())
  jobNumber  String     @unique @map("job_number")
  client     Client     @relation(fields: [clientId], references: [id])
  clientId   String     @map("client_id")
  subject    String
  date       DateTime?
  year       Int
  totalCost  Float      @default(0) @map("total_cost")
  totalSell  Float      @default(0) @map("total_sell")
  marginPct  Float      @default(0) @map("margin_pct")
  sourceFile String     @map("source_file")
  status     String     @default("active")
  lineItems  LineItem[]
  createdAt  DateTime   @default(now()) @map("created_at")

  @@index([clientId])
  @@index([year])
  @@index([status])
  @@map("projects")
}

model LineItem {
  id           String     @id @default(uuid())
  project      Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId    String     @map("project_id")
  itemNumber   Int        @map("item_number")
  description  String
  category     Category?  @relation(fields: [categoryId], references: [id])
  categoryId   String?    @map("category_id")
  quantity     Float      @default(1)
  unitCost     Float      @default(0) @map("unit_cost")
  totalCost    Float      @default(0) @map("total_cost")
  unitSelling  Float      @default(0) @map("unit_selling")
  totalSelling Float      @default(0) @map("total_selling")
  marginAmount Float      @default(0) @map("margin_amount")
  marginPct    Float      @default(0) @map("margin_pct")
  vendor       Vendor?    @relation(fields: [vendorId], references: [id])
  vendorId     String?    @map("vendor_id")
  vendorRaw    String?    @map("vendor_raw")
  alerts       PriceAlert[]
  createdAt    DateTime   @default(now()) @map("created_at")

  @@index([projectId])
  @@index([categoryId])
  @@index([vendorId])
  @@map("line_items")
}

model Category {
  id       String     @id @default(uuid())
  name     String     @unique
  keywords String[]
  items    LineItem[]

  @@map("categories")
}

model MarketPrice {
  id          String   @id @default(uuid())
  itemName    String   @map("item_name")
  supplier    String
  unitPrice   Float    @map("unit_price")
  unit        String
  url         String?
  lastChecked DateTime @default(now()) @map("last_checked")
  isActive    Boolean  @default(true) @map("is_active")

  @@map("market_prices")
}

model PriceAlert {
  id            String   @id @default(uuid())
  lineItem      LineItem @relation(fields: [lineItemId], references: [id], onDelete: Cascade)
  lineItemId    String   @map("line_item_id")
  alertType     String   @map("alert_type")
  message       String
  historicalAvg Float    @map("historical_avg")
  quotedPrice   Float    @map("quoted_price")
  deviationPct  Float    @map("deviation_pct")
  resolved      Boolean  @default(false)
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([lineItemId])
  @@index([alertType])
  @@map("price_alerts")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  role      String   @default("user")
  avatar    String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}
